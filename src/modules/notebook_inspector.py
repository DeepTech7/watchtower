# (((((((((((((##########%%%#((((((((((((((((((((((((((((((((((((((((##%%%%%%%%%%###%#/,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# (((((((((((((((((##########%%%##(((((((((((((((((((((((((((((##%%%%%%%%%%####(*,........,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# (((((((((((((((((((((((#########%%%%&&&&%#(((((((((##%&&&&&&%%%%%%##%##/,,,..,...,,,.......,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# ((((((((((((((((((((((((((((#&@#((/((((((((((((((((((((((((((((#@%...,,,,...................,,,,,,,,,,,,,,,,,,,,,,,,,,,,
# (((((((((((((((((((((((((%@(((((((((((((((((((((((((((((((((((((((((#&&*...................,..,,,,,,,,,,,,,,,,,,,,,,,,,,
# ((((((((((((((((((((#((&#((((((((((((((((((((((((((((((((((((((((((((((((%&/..,.,...............,,,,,,,,,,,,,,,,,,,,,,,,
# %%%#(((((((((((((((((&(((((((((((((((((((((((((((((((((((((((((((((((((((((((&#,...,.............,,,,,,,,,,,,,,,,,,,,,,,
# ####%%###((((((((((%%((((((((((((((((((((((((((/((((((((((((((((((((((((((((((((%#,..,,........,...,,,,,,,,,,,,,,,,,,,,,
# ((#######%%%##(((#&#((((((((((((((((((((((((/((//((((((((((((((((((((((((((((((((((&/................,,,,,,,,,,,,,,,,,,,
# ((((((#####%%%%%%&#((((((((((((((((((((((##//*///(%((((((((((((((((((((((((((((((((((%%////*.....,....,,,,,,,,,,,,,,,,,,
# ((((##%%%%%%%%%%&%((((((((((((((((((((((#///%(*////*#((((((((#(((((((((((((((((((((((((#%(((((%&*.,..,..,,,,,,,,,,,,,,,,
# %%%%%%##%#(/,.,.%((((((((((((((((((((((#*/((#&(//*/*/%(((((((/(%#(((((((((((((((((((((((((%(((((%(.,......,,,,,,,,,,,,,,
# %%##/....,,....,%((((((((((((((((((((((%**/AISHIELD*/#((((((((((/(%#(((((((((((((((((((((((((((((&.,.......,,,,,,,,,,,,,
# ................/&((((((((((&(/(((((((((#(*/(((/(**(#(((((((((((((((((%#((((((((((((((((((((((((&*.,,........,,,,,,,,,,,
# ................./#(((((((((/%((((((((((/(((#%%%##(((((((((((((((((((((((((%%#/(((((((((((((((&(..,..........,,,,,,,,,,,
# ................,.*@((((((((((%(((((((((((((((((((((((((#######%%#####((((((((((((###%%#&%(*,.....,.........,...,,,,,,,,
# ..................,.,&%((((((((#(((((((/((#%&&&&&&&%%%&&&&&&&&&&&&%%%&%&%&%%%%%%%&&&&&&%%@,..,.................,..,,,,,,
# .................,,....,,/#&&%#%%((#%&&%&%&&%%%%%%%%%%%%%%%%%%%%%%&&&&&%%%%%%%%%&&&&&%&&%&(,*,,..................,..,,,,
# .............................,,.(&%%%%%&%&%%%&&%%%%%%&&&&@&&%####(%#/%@@@%///////&@&&@@@&(**///&,,.,.................,,,
# ................................,#&%&%%&%%&&&%##((((((((((((((%&&@@&(////*/////(###&@&&%///#(///%/.....................,
# ................................,.&&%#((((((((((((((((((##&@@@%#/*/((#%(/*,&@@@(//*/#&&//#///////&,,...................,
# ................................,%((((((((((((((#%%(/////#%@@@@@@@@@@&,,.,@@@@@&*///*##//&(((////&,,................,,..
# ........,..,...,............,..(%((##&%#(/*/(%%&@@@@//////&@@@@@@@@@%.,,,@@@@@@@*/////*/////#///(#,.....................
# ......,...*@/*##...........,.,.../&@@@@@@@#.,.(@@@@@%#/////%@@@@@@@(,,.*@@@@@@@%///////**//////&*..,....................
# ...........#(///%(..,.............&@@@@@@*,..#@@@@@@//////*//%@@@@*,,.,@@@@@@@@///////#&%%#%%(,.........................
# .......,.,,,,&(/*/&*.,..........,,,&@@@&,.,.(@@@@@@(////////////%/,.,/@@@@@@%/*///////#*.....,,.........................
# ......,....,..*&///(%..,............#@%,.,,#@@@@@@///*(#/*///////////*//////////*////&*......,,.........................
# .......,.,.,#(/*#//*/&,,,.........,...(%,.#@@@@&(//*//*///////////////////////////*#%,......,.,.........................
# .......,,##/((//#/*///%/...............,&///**///////////(@&&&#///////////////*//##/////#((%&(,,........................
# .......,%##/#%((##%(((/((.,..........,.,,&(*///*//////////&&@%&//////////////*/%((((//((%/(((/((%%/,..,.................
# ......,(%//#(*//////////(%....,...........,#&(/////////////(#///////////*/*(%(((((((//(#((((((((((%((&#,.,,.............
# ........,&%/%/*/#/*///*//((,..............,.,,*&&(///////////*/*///////#&#(/((((((((/*(##(((((((##((%///*%%,.,..........
# ..........,&(/////#/*//////&,.,........,,...#&#((/((((#&#(//*//**(&#((/(/#((((((((/((*/(%((((//(#((#/////////&/...,,....
# ............,(%/*////*///////%*........./&#((((%(((((((%((((((##*#(((((##&((((((((((((*(#%(((((&((#///////*/*///#%,.,...
# ...........,,..,&/////////////*%(...,(&###((((((%((((((%((((##%#(%((@&((((//////((%%(((*/(%*%&%((((/*//////////////#%,..
# ................,,%*/////////*//*#@%//(#((##(((((%/(((((((/(((((((%/(((((/,*/((#%&%#%(((//%/,,.,#&(///////////////////&/
# .................,.*%////////*//*///%//*/#((#(((((%((((((((#%@%(,%(%(((((%((((((((%#(#((//(#.,,.,,,./&(/////////////////
# ................,.,..*&//////////////////*(#((%(&/,@(((&(%###&%#(#(#((((((#/*/(##((/(&(*/((&.,........,./&////*/////////
# .....................,.*&///////////**///*//%&/,,..,(%((#/(((((##(##%(((((#((/*//((/*/#((/(&,........,,.,..##*//////////
# ......................,.,,&(/////////////(&*...,.....,&((%(((((((((#(##&&((#(((##%%#(((((((%/................/%/////////
# .......................,..,,#%*///////(&,.,..........,.##(#(((((((((%##(/((((((((((((((((((##.................,,&///////
# ............................,,(%///%&,...............,../&(&%%((((((((%(((((((((((((((((((((#,..................,,&////*
# ............................,.,.,/,,.,....,............,,,&((((((((((((#((((((((((((((((((((&,.....................,@//*

__author__ = "AIShield"
__copyright__ = "Copyright @2023 Bosch Global Software Technologies Private Limited."
__credits__ = "AIShield"
__license__ = "Apache-2.0"
__version__ = "1.0"
__maintainer__ = "AIShield"
__email__ = "AIShield.Contact@bosch.com"
__status__ = "Beta"

from utils import notebook_inspector_util


def scan(file_name: str, requirement_file: str):
    """
        Description: This function will take two parameters notebook file path and requirement file path
                        It will scan the notebook and requirement file using open source libraries and will return an
                        output json to the orchestrator

        input_parameter :
                file_name : ipynb notebook file path
                requirement_file : requirement.txt file path

        return parameter:
                output_json: output_json
                scanning_status: By default True , if it fails will return False

    """

    # Initializing an empty output dictionary
    output_json = dict()

    # Initializing an empty tool-wise list for dumping the outputs
    tool_wise_output = list()

    # default scanning status set as True , if fails make it to False
    # this scanning_status will be utilized by orchestrator for demonstrate the output_json report to text file
    overall_scanning_status = True
    notebook_scanning_status = True
    requirement_file_scanning_status = True

    notebook_scanning_tools = ['Detect-Secret', 'Whisper', 'Presidio-Analyzer', 'Safety']
    """TODO : git-secret integration feature will be coming soon"""

    requirement_file_scanning_tools = ['Safety']

    # check any ipynb file is present for scanning or not
    if len(file_name) != 0:
        try:
            output_json['file_name'] = file_name
            # Check the file name has any whitespace character (" ")  or not
            # if file_name has any whitespace character , then
            # it will be unable to convert .ipynb to .py format
            # so need to rename the file name by adding some special character
            whitespace_character = " "
            file_name = notebook_inspector_util.has_whitespace_character(
                file_name=file_name, whitespace_character=whitespace_character)
            # Print a message to indicate the start of the conversion
            print("Notebook Scanning started for file {}".format(file_name))
            # Add the file path for got for scanning to the output json
            
            extension = file_name.split(".")[-1] # Check the extension of the file
            # Converting ipynb file to py format file for scanning
            if extension=="py":
                py_file = file_name # If the file is .py file, conversion is not needed, hence assigning file_name to py_file
            else:
                py_file = notebook_inspector_util.convert_ipynb_to_py_format(file_name) # If file is .ipynb file, convert it to .py file
            if py_file is not None:
                # list the scanning tools included for notebook scanning part

                # iterate over the tools mentioned
                for tool_name in notebook_scanning_tools:

                    output = ""
                    # Initialize and empty dictionary
                    individual_tool_output = dict()
                    individual_tool_output['tool'] = tool_name

                    # Start Detect-Secret Scanning for that given ipynb file
                    if tool_name.lower() == "detect-secret":
                        output, _ = notebook_inspector_util.detect_secrets_scanning(py_file)

                    # Start whisper Scanning for that given ipynb file
                    elif tool_name.lower() == "whisper":
                        output, _ = notebook_inspector_util.whisper_scanning(py_file)

                    # Start presidio-analyzer Scanning for that given ipynb file
                    elif tool_name.lower() == "presidio-analyzer":
                        output, _ = notebook_inspector_util.presidio_analyzer_scanning(py_file)

                    # Start safety Scanning for that given ipynb file
                    elif tool_name.lower() == "safety":

                        # extract the requirements present in the provided notebook and
                        # save as a txt file if we found any packages and versions mentioned
                        fetch_req_file = notebook_inspector_util.extract_packages_from_ipynb_file(py_file)
                        if len(fetch_req_file) != 0:
                            output, _ = notebook_inspector_util.requirement_file_scanning(fetch_req_file)

                    individual_tool_output['output_log'] = str(output)

                    # Append the individual tool output to a consolidated result output
                    tool_wise_output.append(individual_tool_output)

                # Print a message to indicate the completion of the conversion
                print("Notebook Scanning Completed for file {}".format(file_name))
            else:
                notebook_scanning_status = False

        except Exception as e:
            notebook_scanning_status = False
            print('Scanning Notebook Failed {}'.format(str(e)))

    if len(requirement_file) != 0:
        try:
            print("Requirement file Scanning Started for file {}".format(requirement_file))

            output_json['requirement_file'] = requirement_file
            for tool_name in requirement_file_scanning_tools:

                output = ""
                # Initialize and empty dictionary
                individual_tool_output = dict()
                individual_tool_output['tool'] = tool_name

                print(
                    'Scanning for vulnerable and non-permissible libraries for {} started'.format(requirement_file))
                if tool_name.lower() == "safety":
                    output, _ = notebook_inspector_util.requirement_file_scanning(requirement_file)

                individual_tool_output['output_log'] = str(output)

                tool_wise_output.append(individual_tool_output)
            print('Scanning for vulnerable and non-permissible libraries for {} completed'.format(requirement_file))
            print("Requirement file Scanning completed for file {}".format(requirement_file))

        except Exception as e:
            requirement_file_scanning_status = False
            print('Scanning requirement files Failed {}'.format(str(e)))

        if not (notebook_scanning_status and requirement_file_scanning_status):
            overall_scanning_status = False

    output_json['scanning_reports'] = tool_wise_output

    return output_json, overall_scanning_status
